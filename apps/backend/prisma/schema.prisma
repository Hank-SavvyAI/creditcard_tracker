generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int             @id @default(autoincrement())
  telegramId    String?         @unique
  googleId      String?         @unique
  lineId        String?         @unique
  email         String?         @unique
  username      String?
  firstName     String?
  lastName      String?
  avatar        String?
  language      String          @default("zh-TW")
  tier          String          @default("FREE")
  role          String          @default("USER")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  cards         UserCard[]
  benefits      UserBenefit[]
  benefitHistory UserBenefitHistory[]
  friends       Friendship[]    @relation("UserFriends")
  friendOf      Friendship[]    @relation("FriendOfUser")
  pushSubscriptions PushSubscription[]
  loginTokens   LoginToken[]
  notificationLogs NotificationLog[]
}

model PushSubscription {
  id            Int             @id @default(autoincrement())
  userId        Int
  endpoint      String
  p256dh        String          // 公鑰
  auth          String          // 認證密鑰
  userAgent     String?         // 瀏覽器資訊
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
}

model CreditCard {
  id              Int             @id @default(autoincrement())
  name            String
  nameEn          String?
  bank            String
  bankEn          String?
  issuer          String?
  region          String          @default("taiwan")
  type            String          @default("personal") // "personal" | "business"
  description     String?
  descriptionEn   String?
  photo           String?
  fee             String?
  displayPriority Int             @default(999) // Lower number = higher priority
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  benefits        Benefit[]
  userCards       UserCard[]
}

model Benefit {
  id            Int             @id @default(autoincrement())
  cardId        Int
  category      String
  categoryEn    String?
  title         String
  titleEn       String?
  description   String
  descriptionEn String?
  amount        Float?
  currency      String          @default("TWD")
  frequency     String          @default("YEARLY")
  cycleType     String?         // "MONTHLY" | "QUARTERLY" | "YEARLY" | null (一次性)
  startMonth    Int?
  startDay      Int?
  endMonth      Int?
  endDay        Int?
  isPersonalCycle Boolean       @default(false) // 是否依用戶開卡日計算週期
  reminderDays  Int             @default(30)
  notifiable    Boolean         @default(true)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  card          CreditCard      @relation(fields: [cardId], references: [id], onDelete: Cascade)
  userBenefits  UserBenefit[]
  benefitHistory UserBenefitHistory[]
}

model UserCard {
  id            Int             @id @default(autoincrement())
  userId        Int
  cardId        Int
  cardInstance  Int             @default(1)  // 第幾張同樣的卡 (1, 2, 3, ...)
  nickname      String?
  displayOrder  Int             @default(999) // 使用者自訂的卡片顯示順序 (數字越小越前面)
  afChargeMonth Int?            // Annual fee charge month (1-12)
  afChargeDay   Int?            // Annual fee charge day (1-31)
  openedAt      DateTime?       // Card opening date (用於計算 5/24 rule)
  addedAt       DateTime        @default(now())

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  card          CreditCard      @relation(fields: [cardId], references: [id], onDelete: Cascade)
  userBenefits  UserBenefit[]   // 此卡的福利使用記錄

  @@unique([userId, cardId, cardInstance])
}

model UserBenefit {
  id                Int             @id @default(autoincrement())
  userId            Int             // 保留用於查詢
  userCardId        Int             // 綁定到具體的 UserCard
  benefitId         Int?            // 自定義福利時為 null
  year              Int
  cycleNumber       Int?            // 1-12(月), 1-4(季), 1(年), null(一次性)
  periodEnd         DateTime?       // 週期結束時間，用於判斷是否需要歸檔
  customStartDate   DateTime?       // 個人化起始日期（用於 isPersonalCycle 的福利）
  isCompleted       Boolean         @default(false)
  completedAt       DateTime?
  notes             String?
  reminderDays      Int?            // 自訂提醒天數，null 表示使用 Benefit 的預設值
  notificationEnabled Boolean       @default(true) // 是否啟用通知
  usedAmount        Float?          @default(0)    // 已使用金額
  isHidden          Boolean         @default(false) // 使用者是否隱藏此福利

  // 自定義福利字段
  isCustom          Boolean         @default(false) // 是否為自定義福利（開卡禮、續卡禮等）
  customTitle       String?         // 自定義福利名稱（中文）
  customTitleEn     String?         // 自定義福利名稱（英文）
  customAmount      Float?          // 自定義福利總金額
  customCurrency    String?         // 自定義福利幣別
  customDescription String?         // 自定義福利描述（例如：開卡禮內容）

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userCard      UserCard        @relation(fields: [userCardId], references: [id], onDelete: Cascade)
  benefit       Benefit?        @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  usages        BenefitUsage[]

  @@index([userCardId, benefitId, year, cycleNumber])
  @@index([userCardId, year, isCustom])
}

model BenefitUsage {
  id            Int             @id @default(autoincrement())
  userBenefitId Int
  amount        Float           // 本次使用/報銷金額
  usedAt        DateTime        // 使用日期
  note          String?         // 使用備註
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  userBenefit   UserBenefit     @relation(fields: [userBenefitId], references: [id], onDelete: Cascade)
}

// 歷史記錄表 - 用於保存已歸檔的福利記錄
model UserBenefitHistory {
  id                Int             @id @default(autoincrement())
  userId            Int
  userCardId        Int             // 記錄是哪張卡的福利
  benefitId         Int
  year              Int
  cycleNumber       Int?
  periodEnd         DateTime?
  isCompleted       Boolean
  completedAt       DateTime?
  notes             String?
  reminderDays      Int?
  notificationEnabled Boolean
  usedAmount        Float?
  archivedAt        DateTime        @default(now())  // 歸檔時間
  createdAt         DateTime        // 原始創建時間
  updatedAt         DateTime        // 原始更新時間

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  benefit       Benefit         @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  usages        BenefitUsageHistory[]

  @@index([userId, benefitId, year, cycleNumber])
  @@index([userCardId, benefitId, year, cycleNumber])
}

// 歷史使用記錄表
model BenefitUsageHistory {
  id            Int             @id @default(autoincrement())
  historyId     Int             // 對應 UserBenefitHistory 的 id
  amount        Float
  usedAt        DateTime
  note          String?
  archivedAt    DateTime        @default(now())
  createdAt     DateTime
  updatedAt     DateTime

  history       UserBenefitHistory @relation(fields: [historyId], references: [id], onDelete: Cascade)
}

model Friendship {
  id            Int             @id @default(autoincrement())
  userId        Int
  friendId      Int
  status        String          @default("PENDING")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user          User            @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  friend        User            @relation("FriendOfUser", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
}

model LoginToken {
  id            Int             @id @default(autoincrement())
  userId        Int
  token         String          @unique
  expiresAt     DateTime
  used          Boolean         @default(false)
  source        String          @default("LINE") // "LINE" | "TELEGRAM" | "GOOGLE"
  createdAt     DateTime        @default(now())

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
}

model CronJobLog {
  id              Int      @id @default(autoincrement())
  jobName         String   // "benefit-expiration-check" | "benefit-archiving"
  status          String   // "SUCCESS" | "FAILED" | "PARTIAL"
  startedAt       DateTime
  completedAt     DateTime
  durationMs      Int      // 執行時長（毫秒）
  itemsProcessed  Int      @default(0) // 處理的項目數量
  successCount    Int      @default(0) // 成功數量
  failureCount    Int      @default(0) // 失敗數量
  errorMessage    String?  @db.Text // 錯誤訊息
  details         String?  @db.Text // 詳細資訊（JSON 格式）
  createdAt       DateTime @default(now())

  @@index([jobName])
  @@index([status])
  @@index([startedAt])
}

model NotificationLog {
  id              Int      @id @default(autoincrement())
  userId          Int
  notificationType String  // "benefit-expiration" | "benefit-reminder" | "system" | "test"
  channel         String   // "telegram" | "line" | "email" | "webpush"
  status          String   // "SUCCESS" | "FAILED"
  title           String
  body            String   @db.Text
  errorMessage    String?  @db.Text
  metadata        String?  @db.Text // JSON 格式，儲存額外資訊（如 benefitId, userBenefitId 等）
  sentAt          DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([notificationType])
  @@index([channel])
  @@index([status])
  @@index([sentAt])
}

// SQLite doesn't support enums, use String with constants instead
// UserTier: "FREE" | "PREMIUM" | "VIP"
// UserRole: "USER" | "ADMIN"
// Frequency: "MONTHLY" | "QUARTERLY" | "YEARLY" | "ONE_TIME"
// FriendStatus: "PENDING" | "ACCEPTED" | "REJECTED"
// Region: "taiwan" | "america" | "canada" | "japan" | "singapore" | "other"
// CardType: "personal" | "business"
// NotificationType: "benefit-expiration" | "benefit-reminder" | "system" | "test"
// NotificationChannel: "telegram" | "line" | "email" | "webpush"
// NotificationStatus: "SUCCESS" | "FAILED"
